<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Students Cards</title>

  <!-- Bootstrap 5 + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <style>
    body { background-color: #f8f9fa; }
    .card { transition: all 0.3s ease; border: none; border-radius: 12px; overflow: hidden; }
    .card:hover { transform: translateY(-8px); box-shadow: 0 12px 25px rgba(0,0,0,0.15)!important; }
    .card-body { padding: 1.5rem; }
    .card-title { font-size: 1.3rem; font-weight: 600; color: #2c3e50; margin-bottom: 0.75rem; }
    .card-text { font-size: 0.95rem; color: #555; margin-bottom: 0.5rem; }
    .email { font-family: 'Courier New', monospace; font-size: 0.88rem; color: #2c3e50; }
    .email a { color: #0d6efd; text-decoration: none; font-weight: 500; }
    .email a:hover { text-decoration: underline; }
    .badge-age { background-color: #e3f2fd; color: #1976d2; font-weight: 600; padding: 0.35em 0.65em; font-size: 0.8rem; border-radius: 50px; }

    .btn-edit, .btn-delete {
      padding: 0.4rem 0.8rem; font-size: 0.85rem; border-radius: 8px; transition: all 0.2s;
    }
    .btn-edit { background: #ffc107; color: white; border: none; }
    .btn-edit:hover { background: #e0a800; transform: scale(1.05); }
    .btn-delete { background: #dc3545; color: white; border: none; }
    .btn-delete:hover { background: #c82333; transform: scale(1.05); }

    .edit-form input { font-size: 0.9rem; }
    .edit-actions button { font-size: 0.8rem; padding: 0.3rem 0.6rem; }

    /* Snackbar */
    #snackbar {
      visibility: hidden; min-width: 280px; background-color: #333; color: #fff;
      text-align: center; border-radius: 8px; padding: 16px; position: fixed;
      z-index: 1000; left: 50%; bottom: 30px; font-size: 1rem;
      transform: translateX(-50%); box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      opacity: 0; transition: opacity 0.3s, visibility 0.3s;
    }
    #snackbar.show { visibility: visible; opacity: 1; }
    #snackbar.success { background-color: #28a745; }
    #snackbar.error { background-color: #dc3545; }
  </style>
</head>
<body>

  <div class="container py-5">
    <h1 class="text-center mb-5 fw-bold text-primary">Our Students</h1>

    <div class="text-center mb-4">
      <a href="/add-student" class="btn btn-success btn-lg shadow-sm">
        Add More Student
      </a>
    </div>

    <% if (users && users.length > 0) { %>
      <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4" id="students-container">
        <% users.forEach(student => { %>
          <div class="col" data-id="<%= student._id %>">
            <div class="card h-100 shadow-sm">
              <div class="card-body d-flex flex-column">

                <!-- VIEW MODE -->
                <div class="view-mode">
                  <h5 class="card-title text-capitalize mb-3"><%= student.name %></h5>
                  <p class="card-text mb-2"><span class="badge-age"><%= student.age %> years old</span></p>
                  <p class="card-text email mb-3">
                    <strong>Email:</strong><br>
                    <a href="mailto:<%= student.email %>"><%= student.email %></a>
                  </p>

                  <div class="d-flex gap-2 mt-auto">
                    <button class="btn btn-edit flex-fill" onclick="enableEdit(this)">
                      Edit
                    </button>
                    <button class="btn btn-delete flex-fill" onclick="confirmDelete('<%= student._id %>', '<%= student.name %>', this)">
                      Delete
                    </button>
                  </div>
                </div>

                <!-- EDIT MODE -->
                <div class="edit-mode d-none">
                  <form class="edit-form" onsubmit="saveStudent(event, '<%= student._id %>')">
                    <div class="mb-2">
                      <input type="text" class="form-control form-control-sm" name="name" value="<%= student.name %>" required>
                    </div>
                    <div class="mb-2">
                      <input type="number" class="form-control form-control-sm" name="age" value="<%= student.age %>" min="1" required>
                    </div>
                    <div class="mb-2">
                      <input type="email" class="form-control form-control-sm" name="email" value="<%= student.email %>" required>
                    </div>
                    <div class="edit-actions d-flex gap-1">
                      <button type="submit" class="btn btn-success btn-sm flex-fill">Save</button>
                      <button type="button" class="btn btn-secondary btn-sm flex-fill" onclick="cancelEdit(this)">Cancel</button>
                    </div>
                  </form>
                </div>

              </div>
            </div>
          </div>
        <% }) %>
      </div>
    <% } else { %>
      <div class="text-center py-5">
        <p class="no-data">No students found in the database.</p>
      </div>
    <% } %>
  </div>

  <!-- Snackbar -->
  <div id="snackbar"></div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Snackbar
    function showSnackbar(message, type = 'success') {
      const snackbar = document.getElementById('snackbar');
      snackbar.textContent = message;
      snackbar.className = `show ${type}`;
      setTimeout(() => snackbar.className = snackbar.className.replace('show', ''), 3000);
    }

    // Delete
    async function confirmDelete(id, name, btn) {
      if (!confirm(`Are you sure you want to delete "${name}"?`)) return;
      try {
        const res = await fetch(`/delete-student/${id}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.message === "Student successfully deleted") {
          btn.closest('.col').remove();
          showSnackbar(`"${name}" deleted!`, 'success');
          checkEmpty();
        } else {
          showSnackbar(data.message || 'Delete failed', 'error');
        }
      } catch (err) {
        showSnackbar('Network error!', 'error');
      }
    }

    // Enable Edit
    function enableEdit(btn) {
      const cardBody = btn.closest('.card-body');
      cardBody.querySelector('.view-mode').classList.add('d-none');
      cardBody.querySelector('.edit-mode').classList.remove('d-none');
    }

    // Cancel Edit
    function cancelEdit(btn) {
      const cardBody = btn.closest('.card-body');
      cardBody.querySelector('.edit-mode').classList.add('d-none');
      cardBody.querySelector('.view-mode').classList.remove('d-none');
    }

    // Save Update
    async function saveStudent(e, id) {
      e.preventDefault();
      const form = e.target;
      const cardBody = form.closest('.card-body');
      const formData = new FormData(form);
      const payload = Object.fromEntries(formData);

      try {
        const res = await fetch(`/update-student/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const result = await res.json();

        if (result.message === "Student successfully updated") {
          // Update UI
          cardBody.querySelector('.card-title').textContent = payload.name;
          cardBody.querySelector('.badge-age').textContent = `${payload.age} years old`;
          const emailLink = cardBody.querySelector('.email a');
          emailLink.textContent = payload.email;
          emailLink.href = `mailto:${payload.email}`;

          // Switch to view mode
          cardBody.querySelector('.edit-mode').classList.add('d-none');
          cardBody.querySelector('.view-mode').classList.remove('d-none');

          showSnackbar(`"${payload.name}" updated!`, 'success');
        } else {
          showSnackbar(result.message || 'Update failed', 'error');
        }
      } catch (err) {
        showSnackbar('Network error!', 'error');
      }
    }

    // Check if no students
    function checkEmpty() {
      const container = document.getElementById('students-container');
      if (container && container.querySelectorAll('.col').length === 0) {
        container.innerHTML = `
          <div class="col-12 text-center py-5">
            <p class="no-data">No students found in the database.</p>
          </div>`;
      }
    }
  </script>
</body>
</html>